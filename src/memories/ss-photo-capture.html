<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">

<link rel="import" href="../../bower_components/polymerfire/firebase-storage-ref.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-upload-task.html">

<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">


<dom-module id="ss-photo-capture">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;

            }

            paper-tabs {
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                width: 100%;
                font-size: larger;
                text-transform: uppercase;
                margin-bottom: 1px;
                background-color: #5D7AF2;
                color: white;
            }

            #photoCanvas {
                max-width: 100%;
                width: 100%;
            }

            #photoPreview {
                max-width: 100%;
                width: 100%;
            }

            #selfie {
                height: 200px;
                display: block;
            }

        </style>

                <div>

                    <h1>Take a Snap</h1>

                    <img id="selfie" src="images/avatar-placeholder.svg">

                    <firebase-storage-ref id="firebaseStorage"
                            app="{{fbApp}}"
                            path="{{fsPath}}"
                            metadata="{{fsMetadata}}"
                            storage-uri="{{fsStorage}}"
                            download-url="{{fsDownload}}"
                            >
                    </firebase-storage-ref>

                    <firebase-storage-upload-task
                            task="[[fsTask]]"
                            bytes-transferred="{{fsBytesTransferred}}"
                            total-bytes="{{fsTotalBytes}}"
                            state="{{fsState}}"
                            ></firebase-storage-upload-task>

                    <input id="photoUpload" type="file" accept="image/*" capture on-change="uploadPhotos" on-click="toggleFullScreenPhoto">
                    <template is="dom-if" if="{{fsCurrentlyUploading}}">
                        <paper-progress max="{{fsTotalBytes}}" value="{{fsBytesTransferred}}"></paper-progress>
                        <div>Transferring {{fsBytesTransferred}} of {{fsTotalBytes}}  ({{fsState}})</div>
                    </template>
                </div>
                <div>

    </template>

    <script>
        class PhotoCapture extends Polymer.Element {
            static get is() {
                return 'ss-photo-capture';
            }

            static get properties() {
                return {
                    fbApp: Object,
                    fsMetadata: Object,
                    fsPath: {
                        type: String,
                        value: '/photos',
                    },
                    fsStorage: {
                        type: String,
                        value: 'gs://sights-sounds-pwa.appspot.com/photos',
                    },
                    fsDownload: String,
                    toastText: String,
                    fsTask: String,
                    fsBytesTransferred: Number,
                    fsTotalBytes: Number,
                    fsState: Object,
                    fsCurrentlyUploading: {
                        type: Boolean,
                        computed: 'computeUploading(fsState)'
                    }
                   
                };
            }

            ready() {
                super.ready();
                this.$.selfie.addEventListener('click', this.toggleFullScreenPhoto.bind(this));
            }

            computeUploading(fsState) {
                return fsState == 'running';
            }

            uploadPhotos(evt) {
                console.log('Uploading file(s)');
                var files = evt.target.files;

                var fbs = this.$.firebaseStorage;
                fbs.log = true;
                if (files && files.length > 0) {
                    var file = files[0];
                    this.$.selfie.src = URL.createObjectURL(file);

                    // for (var f = 0; f < files.length; f++) {
                    //     var file = files[f];
                    //     this.$.selfie.src = URL.createObjectURL(file);
                    //     // console.log('Uploading ', file.name);
                    //     // var uploadTask = fbs.put(file);
                    //     // console.log(uploadTask);
                    //     // this.fsTask = uploadTask;
                    // }
                }
            }

            toggleFullScreenPhoto() {
                console.log("Tapped the image!!");
                var img = this.$.selfie;
                console.log(img);
                
                img.requestFullScreen =  img.requestFullScreen ||
                                    img.webkitRequestFullScreen ||
                                    img.mozRequestFullScreen;

                if (img.requestFullScreen) {
                    img.requestFullScreen(); 
                } else {
                    console.log("Fullscreen not supported");
                }     
            }

        }

        window.customElements.define(PhotoCapture.is, PhotoCapture);
    </script>
</dom-module>
