<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">


<dom-module id="ss-audio-capture-api">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;

            }

            
        </style>

        <div>

            <h1>API Edition - Take an Audio Voice Note</h1>

            <template is="dom-if" if="[[!apiSupported]]">

                <h3>Sorry, your browser doesn't support this API</h3>

            </template>

            <paper-dropdown-menu label="Audio Source">
                <paper-listbox slot="dropdown-content" selected="{{selectedAudioIdx}}">
                    <template is="dom-repeat" items="[[audioDevices]]">
                        <paper-item>[[item.label]] ([[item.deviceId]])</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>

            <audio id="voiceNote" controls>
                Your browser does not support the audio tag.
            </audio>

            <paper-fab icon="image:add-a-photo" on-click="startAudio"></paper-fab>
            <paper-fab icon="done" on-click="stopAudio"></paper-fab>
            
        </div>
        <div>

    </template>

    <script>
        class AudioCaptureApi extends Polymer.Element {

            static get is() {
                return 'ss-audio-capture-api';
            }

            static get properties() {
                return {

                    apiSupported: {
                        type: Boolean,
                        value: true
                    },
                    mediaRecorder: {
                        type: Object
                    },
                    recordedAudio: {
                        type: Array,
                        value: []
                    },
                    selectedAudioIdx: {
                        type: Number,
                        value: 0,
                    },
                    audioActive: {
                        type: Boolean,
                        value: false,
                    },
                    audioDevices: {
                        type: Array,
                        value: []
                    }

                    

                };
            }

           ready() {
                super.ready();
                let apiSupported = 'mediaDevices' in navigator;
                this.set('apiSupported', apiSupported);
                this.listDevices();
            }

            listDevices() {
                let self = this;
                navigator.mediaDevices.enumerateDevices()
                    .then(function (devices) {
                        let cameras = []
                        devices.forEach(function (device) {
                            console.log(device.kind + ": " + device.label +
                                " id = " + device.deviceId);
                            if (device.kind === 'audioinput') {
                                cameras.push(device);
                            }
                        });
                        self.set('audioDevices', cameras);
                    })
                    .catch(function (err) {
                        console.log(err.name + ": " + err.message);
                    });
            }

            startAudio() {

                const audioPreview = this.$.voiceNote;

                var allDevices = this.get('audioDevices');
                var comboSelection = this.get('selectedAudioIdx');
                console.log(allDevices, comboSelection);
                var selectedAudio = allDevices[comboSelection];
                console.log("Switching audio to: ", selectedAudio);

                let constraints = {
                    audio: {
                        deviceId: selectedAudio.deviceId
                    },
                    video: false
                }

                let self = this;

                navigator.mediaDevices.getUserMedia(constraints)
                    .then((stream) => {
                        var mediaRecorder = new MediaRecorder(stream);
                        this.set('mediaRecorder', mediaRecorder);
                        mediaRecorder.start();
                        console.log(mediaRecorder.state);
                        let chunks = [];
                        self.set('recordedAudio', chunks);

                        mediaRecorder.ondataavailable = function(e) {
                             chunks.push(e.data);
                             console.log("Chunking");
                        }

                        mediaRecorder.onstop = function(e) {

                            console.log("Stopping and creating audio");
                            let recordedAudio = self.get('recordedAudio');
                            console.log(recordedAudio);
                            var blob = new Blob(recordedAudio, { 'type' : 'audio/webm' });
                            
                            audioPreview.src = URL.createObjectURL(blob);

                        }

                        //audioPreview.srcObject = stream;
                    }, (err) => {
                        console.log('User rejected camera capture permissions', err);
                    });
            }

            stopAudio() {

                console.log("Stopping audio");
                const audioPreview = this.$.voiceNote;
                //audioPreview.srcObject.getAudioTracks().forEach(track => track.stop());
                var mr = this.get('mediaRecorder');
                if (mr) {
                    mr.stop();
                    console.log(mr.state);
                    
                }

                
            }

           

        }

        window.customElements.define(AudioCaptureApi.is, AudioCaptureApi);
    </script>
</dom-module>
